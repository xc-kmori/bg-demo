# タスク管理システム - シーケンス図

## 1. ユーザー認証フロー

### 1.1 ユーザー登録シーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド
    participant A as Flask API
    participant D as データベース
    
    U->>F: 登録フォーム入力<br/>(username, email, password)
    F->>F: フォームバリデーション
    F->>A: POST /api/auth/register<br/>{username, email, password}
    
    A->>A: 入力データバリデーション
    A->>D: ユーザー名重複チェック<br/>SELECT * FROM users WHERE username=?
    D-->>A: 結果返却
    
    alt ユーザー名が重複
        A-->>F: 409 Conflict<br/>{"error": "ユーザー名が既に存在"}
        F-->>U: エラーメッセージ表示
    else ユーザー名が利用可能
        A->>D: メールアドレス重複チェック<br/>SELECT * FROM users WHERE email=?
        D-->>A: 結果返却
        
        alt メールアドレスが重複
            A-->>F: 409 Conflict<br/>{"error": "メールアドレスが既に登録済み"}
            F-->>U: エラーメッセージ表示
        else 新規ユーザー作成可能
            A->>A: パスワードハッシュ化<br/>(Werkzeug PBKDF2)
            A->>D: ユーザー登録<br/>INSERT INTO users
            D-->>A: 登録完了
            A-->>F: 201 Created<br/>{"message": "登録完了", "user": {...}}
            F-->>U: 登録成功メッセージ<br/>ログイン画面へ遷移
        end
    end
```

### 1.2 ログインシーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド
    participant A as Flask API
    participant J as JWT Manager
    participant D as データベース
    
    U->>F: ログインフォーム入力<br/>(username, password)
    F->>A: POST /api/auth/login<br/>{username, password}
    
    A->>D: ユーザー情報取得<br/>SELECT * FROM users WHERE username=?
    D-->>A: ユーザーデータ返却
    
    alt ユーザーが存在しない
        A-->>F: 401 Unauthorized<br/>{"error": "認証失敗"}
        F-->>U: エラーメッセージ表示
    else ユーザーが存在
        A->>A: パスワード検証<br/>check_password_hash()
        
        alt パスワード不正
            A-->>F: 401 Unauthorized<br/>{"error": "認証失敗"}
            F-->>U: エラーメッセージ表示
        else 認証成功
            A->>J: JWTトークン生成<br/>create_access_token()
            J-->>A: access_token, refresh_token
            A-->>F: 200 OK<br/>{access_token, refresh_token, user}
            F->>F: トークン保存<br/>localStorage
            F->>F: ユーザー状態更新
            F-->>U: ダッシュボード画面表示
        end
    end
```

## 2. タスク管理フロー

### 2.1 タスク作成シーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド
    participant A as Flask API
    participant D as データベース
    
    U->>F: "新規タスク"ボタンクリック
    F->>F: カテゴリ一覧読み込み
    F->>A: GET /api/categories/
    A->>D: ユーザーのカテゴリ取得
    D-->>A: カテゴリ一覧
    A-->>F: カテゴリデータ
    F-->>U: タスク作成モーダル表示
    
    U->>F: タスク情報入力<br/>(title, description, priority, category等)
    U->>F: "作成"ボタンクリック
    F->>F: フォームバリデーション
    F->>A: POST /api/tasks/<br/>{title, description, priority, category_id, due_date}
    
    A->>A: JWTトークン検証
    A->>A: 入力データバリデーション
    
    alt カテゴリIDが指定されている
        A->>D: カテゴリ存在チェック<br/>SELECT * FROM categories WHERE id=? AND user_id=?
        D-->>A: カテゴリデータ
        
        alt カテゴリが存在しない
            A-->>F: 404 Not Found<br/>{"error": "カテゴリが見つかりません"}
            F-->>U: エラーメッセージ表示
        end
    end
    
    A->>D: タスク作成<br/>INSERT INTO tasks
    D-->>A: 作成完了
    A-->>F: 201 Created<br/>{"message": "タスク作成完了", "task": {...}}
    F->>F: タスク一覧更新
    F->>F: 統計情報更新
    F-->>U: 成功メッセージ表示<br/>モーダル閉じる
```

### 2.2 タスク更新シーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド
    participant A as Flask API
    participant D as データベース
    
    U->>F: タスク"編集"ボタンクリック
    F->>A: GET /api/tasks/{task_id}
    A->>A: JWTトークン検証
    A->>D: タスク詳細取得<br/>SELECT * FROM tasks WHERE id=? AND user_id=?
    D-->>A: タスクデータ
    A-->>F: タスク詳細
    F-->>U: 編集モーダル表示<br/>（既存データが入力済み）
    
    U->>F: タスク情報修正
    U->>F: "更新"ボタンクリック
    F->>A: PUT /api/tasks/{task_id}<br/>{title, description, status, priority等}
    
    A->>A: JWTトークン検証
    A->>D: タスク存在チェック<br/>SELECT * FROM tasks WHERE id=? AND user_id=?
    D-->>A: 既存タスクデータ
    
    alt タスクが存在しない
        A-->>F: 404 Not Found
        F-->>U: エラーメッセージ表示
    else タスクが存在
        A->>A: 更新データバリデーション
        
        alt ステータスが'completed'に変更
            A->>A: completed_at = 現在時刻
        end
        
        A->>D: タスク更新<br/>UPDATE tasks SET ... WHERE id=?
        D-->>A: 更新完了
        A-->>F: 200 OK<br/>{"message": "更新完了", "task": {...}}
        F->>F: タスク一覧更新
        F->>F: 統計情報更新
        F-->>U: 成功メッセージ表示
    end
```

## 3. カテゴリ管理フロー

### 3.1 カテゴリ作成シーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド
    participant A as Flask API
    participant D as データベース
    
    U->>F: "新規カテゴリ"ボタンクリック
    F-->>U: カテゴリ作成モーダル表示
    
    U->>F: カテゴリ情報入力<br/>(name, color, description)
    U->>F: "作成"ボタンクリック
    F->>A: POST /api/categories/<br/>{name, color, description}
    
    A->>A: JWTトークン検証
    A->>D: カテゴリ名重複チェック<br/>SELECT * FROM categories WHERE name=? AND user_id=?
    D-->>A: 結果返却
    
    alt カテゴリ名が重複
        A-->>F: 409 Conflict<br/>{"error": "カテゴリ名が既に存在"}
        F-->>U: エラーメッセージ表示
    else 新規作成可能
        A->>D: カテゴリ作成<br/>INSERT INTO categories
        D-->>A: 作成完了
        A-->>F: 201 Created<br/>{"message": "カテゴリ作成完了", "category": {...}}
        F->>F: カテゴリ一覧更新
        F->>F: カテゴリ選択肢更新
        F-->>U: 成功メッセージ表示
    end
```

## 4. ダッシュボード読み込みフロー

### 4.1 ダッシュボード初期化シーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド
    participant A as Flask API
    participant D as データベース
    
    U->>F: ダッシュボード画面選択
    F->>F: 認証状態確認
    
    par 統計情報取得
        F->>A: GET /api/tasks/stats
        A->>A: JWTトークン検証
        A->>D: タスク統計計算<br/>SELECT COUNT(*) FROM tasks WHERE user_id=? GROUP BY status
        D-->>A: 統計データ
        A-->>F: 統計情報
    and 最近のタスク取得
        F->>A: GET /api/tasks/?limit=5
        A->>A: JWTトークン検証
        A->>D: 最新タスク取得<br/>SELECT * FROM tasks WHERE user_id=? ORDER BY created_at DESC LIMIT 5
        D-->>A: タスクリスト
        A-->>F: 最近のタスク
    end
    
    F->>F: ダッシュボード描画
    F-->>U: ダッシュボード表示完了
```

## 5. エラーハンドリングフロー

### 5.1 認証エラー処理シーケンス

```mermaid
sequenceDiagram
    participant F as フロントエンド
    participant A as Flask API
    participant J as JWT Manager
    
    F->>A: API Request<br/>with JWT Token
    A->>J: トークン検証
    
    alt トークン期限切れ
        J-->>A: Token Expired Error
        A-->>F: 401 Unauthorized<br/>{"error": "トークン期限切れ"}
        F->>F: ローカルストレージクリア
        F->>F: ログイン画面表示
        F->>F: エラーメッセージ表示<br/>"セッションが期限切れです"
    else トークン不正
        J-->>A: Invalid Token Error
        A-->>F: 422 Unprocessable Entity<br/>{"error": "不正なトークン"}
        F->>F: ローカルストレージクリア
        F->>F: ログイン画面表示
    else トークン有効
        J-->>A: Token Valid
        A->>A: 処理続行
    end
```

### 5.2 データベースエラー処理シーケンス

```mermaid
sequenceDiagram
    participant F as フロントエンド
    participant A as Flask API
    participant D as データベース
    
    F->>A: データ操作リクエスト
    A->>D: SQL実行
    
    alt データベースエラー発生
        D-->>A: SQLException / IntegrityError
        A->>A: db.session.rollback()
        A->>A: エラーログ出力
        A-->>F: 500 Internal Server Error<br/>{"error": "データベースエラー"}
        F-->>F: エラーメッセージ表示
    else 正常処理
        D-->>A: 処理成功
        A->>A: db.session.commit()
        A-->>F: 200 OK / 201 Created
    end
```

## 6. タスクフィルタリングフロー

### 6.1 フィルタ適用シーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド
    participant A as Flask API
    participant D as データベース
    
    U->>F: フィルタ条件選択<br/>(status, priority, category)
    F->>F: フィルタパラメータ構築
    F->>A: GET /api/tasks/?status=pending&priority=high&category_id=1
    
    A->>A: JWTトークン検証
    A->>A: クエリパラメータ解析
    A->>D: 条件付きタスク取得<br/>SELECT * FROM tasks WHERE user_id=? AND status=? AND priority=? AND category_id=?
    D-->>A: フィルタ済みタスク一覧
    A-->>F: タスクデータ
    F->>F: タスク一覧描画
    F-->>U: フィルタ結果表示
```

## 7. カテゴリ削除フロー

### 7.1 カテゴリ削除シーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド
    participant A as Flask API
    participant D as データベース
    
    U->>F: カテゴリ"削除"ボタンクリック
    F-->>U: 確認ダイアログ表示<br/>"本当に削除しますか？"
    U->>F: 削除確認
    F->>A: DELETE /api/categories/{category_id}
    
    A->>A: JWTトークン検証
    A->>D: カテゴリ存在チェック<br/>SELECT * FROM categories WHERE id=? AND user_id=?
    D-->>A: カテゴリデータ
    
    alt カテゴリが存在しない
        A-->>F: 404 Not Found
        F-->>U: エラーメッセージ表示
    else カテゴリが存在
        A->>D: 関連タスク数チェック<br/>SELECT COUNT(*) FROM tasks WHERE category_id=?
        D-->>A: タスク数
        
        alt 関連タスクが存在
            A-->>F: 409 Conflict<br/>{"error": "関連タスクが存在するため削除不可"}
            F-->>U: エラーメッセージ表示
        else 削除可能
            A->>D: カテゴリ削除<br/>DELETE FROM categories WHERE id=?
            D-->>A: 削除完了
            A-->>F: 200 OK<br/>{"message": "削除完了"}
            F->>F: カテゴリ一覧更新
            F-->>U: 成功メッセージ表示
        end
    end
```

## 8. アプリケーション初期化フロー

### 8.1 アプリケーション起動シーケンス

```mermaid
sequenceDiagram
    participant B as ブラウザ
    participant F as フロントエンド
    participant A as Flask API
    participant D as データベース
    
    B->>F: ページ読み込み<br/>index.html
    F->>F: DOMContentLoaded
    F->>F: ローカルストレージ確認<br/>認証状態チェック
    
    alt 認証トークンが存在
        F->>A: GET /api/auth/me<br/>（トークン検証）
        A->>A: JWTトークン検証
        
        alt トークン有効
            A->>D: ユーザー情報取得
            D-->>A: ユーザーデータ
            A-->>F: ユーザー情報
            F->>F: メイン画面表示
            F->>F: ダッシュボード初期化
        else トークン無効
            A-->>F: 401 Unauthorized
            F->>F: ローカルストレージクリア
            F->>F: ログイン画面表示
        end
    else 認証トークンなし
        F->>F: ログイン画面表示
    end
    
    F-->>B: 初期画面表示完了
```

## 9. データ同期フロー

### 9.1 リアルタイム更新シーケンス

```mermaid
sequenceDiagram
    participant U as ユーザー
    participant F as フロントエンド
    participant A as Flask API
    participant D as データベース
    
    Note over U,D: タスク操作後の自動同期
    
    U->>F: タスク操作実行<br/>（作成・更新・削除）
    F->>A: API Request
    A->>D: データベース操作
    D-->>A: 操作結果
    A-->>F: レスポンス
    
    par 関連データの同期更新
        F->>A: GET /api/tasks/stats<br/>（統計情報更新）
        A->>D: 統計計算
        D-->>A: 最新統計
        A-->>F: 統計データ
    and
        F->>A: GET /api/tasks/?limit=5<br/>（最近のタスク更新）
        A->>D: 最新タスク取得
        D-->>A: タスクリスト
        A-->>F: 最新タスク
    end
    
    F->>F: UI状態更新
    F-->>U: 最新情報表示
```

## 10. エラー復旧フロー

### 10.1 ネットワークエラー処理

```mermaid
sequenceDiagram
    participant F as フロントエンド
    participant A as Flask API
    
    F->>A: API Request
    
    alt ネットワークエラー
        A--xF: Connection Failed
        F->>F: エラー検出
        F->>F: リトライ判定
        
        alt リトライ実行
            F->>A: API Request (Retry)
            A-->>F: Response
        else リトライ上限
            F->>F: エラーメッセージ表示<br/>"接続に失敗しました"
        end
    else サーバーエラー
        A-->>F: 500 Internal Server Error
        F->>F: エラーメッセージ表示<br/>"サーバーエラーが発生しました"
    end
```

---

**作成日**: 2024年12月27日  
**バージョン**: 1.0  
**対象システム**: Personal Task Manager v1.0